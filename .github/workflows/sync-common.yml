name: Sync common files
on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode - only sync to ci-sandbox'
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - 'common/**'
      - '.github/workflows/sync-common.yml'
      - 'scripts/sync-common/**'

# Prevent multiple workflow runs from racing
concurrency: ${{ github.workflow }}

permissions:
  contents: read

jobs:
  build:
    name: Build sync-common tool
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./common/.github/actions/setup-rust

      - name: Build sync-common
        run: cargo build --release --manifest-path scripts/sync-common/Cargo.toml

      - name: Upload sync-common binary
        uses: actions/upload-artifact@v6
        with:
          name: sync-common
          path: scripts/sync-common/target/release/sync-common
          retention-days: 1

  init:
    name: Discover repositories
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-repos.outputs.matrix }}
    steps:
      - name: Generate Actions Token
        id: token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout
        uses: actions/checkout@v6

      - name: Get repository list
        id: get-repos
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.token.outputs.token }}
          script: |
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: context.repo.owner,
              type: 'all',
              per_page: 100
            });

            // Filter out archived repos and this repo itself
            let activeRepos = repos.filter(repo =>
              !repo.archived &&
              repo.name !== context.repo.repo &&
              !repo.name.startsWith('.')
            );

            // Test mode - only sync to ci-sandbox
            const testMode = '${{ github.event.inputs.test_mode }}' === 'true';
            if (testMode) {
              console.log('Test mode enabled - only syncing to ci-sandbox');
              activeRepos = activeRepos.filter(repo => repo.name === 'ci-sandbox');
            }

            const matrix = activeRepos.map(repo => ({
              repo: repo.name,
              full_name: repo.full_name
            }));

            console.log('Discovered repositories:', matrix);
            core.setOutput('matrix', JSON.stringify(matrix));

  sync:
    name: Sync to ${{ matrix.repo }}
    needs: [build, init]
    if: needs.init.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.init.outputs.matrix) }}
    steps:
      - name: Generate Actions Token
        id: token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ matrix.repo }}

      - name: Checkout infra repository
        uses: actions/checkout@v6
        with:
          path: infra
          fetch-depth: 0

      - name: Checkout target repository
        uses: actions/checkout@v6
        with:
          repository: ${{ matrix.full_name }}
          token: ${{ steps.token.outputs.token }}
          path: repo

      - name: Download sync-common binary
        uses: actions/download-artifact@v7
        with:
          name: sync-common
          path: .

      - name: Sync common files to repository
        run: |
          chmod +x sync-common
          ./sync-common infra repo "${{ github.sha }}"

      - name: Open pull request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ steps.token.outputs.token }}
          path: repo
          branch: sync-common-files
          commit-message: |
            Sync common files from infra repository

            Synchronized from ${{ github.repository }}@${{ github.sha }}.
          title: Sync common files from infra repository
          body: |
            Created by [GitHub workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/sync-common.yml) ([source](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/sync-common.yml)).

            This PR synchronizes common files from the [infra repository](${{ github.server_url }}/${{ github.repository }}/tree/main/common).

            Synchronized from ${{ github.repository }}@${{ github.sha }}.
          committer: "bootc-dev Bot <bot@bootc.dev>"
          author: "bootc-dev Bot <bot@bootc.dev>"
          signoff: true
